# finalshell-clone 未实现/不齐全功能点汇总（截至当前代码状态）

本文基于：
- `finalshell-clone/DEVELOPMENT_PLAN.md` 的 P16「待补齐/继续审计」条目
- 代码中可直接定位到的“占位/模拟/未对齐 3.8.3 实现路径”的实现差异

> 说明：这里的“未实现/不齐全”强调 **与 FinalShell 3.8.3（myssh 体系）对齐角度**，以及当前工程内能明确观察到的缺口；不包含后端服务本身（如授权/更新服务器）。

## 0. 项目整体架构与关键数据流（finalshell-clone）

### 0.1 应用入口与生命周期

- **入口类**
  - `com.finalshell.app.App#main(String[])`
  - 解析启动参数（`-min`），初始化 `scheduledExecutor`，然后创建 `App` 单例并执行 `initialize()`。
- **关键初始化序列（主流程）**
  - `App.initialize()`
    - `checkExistingProcess()`：UDP 端口探测防多开（`fs_show/fs_live`）
    - `loadSystemFonts()`：收集系统字体名
    - `ConfigManager.getInstance().init()`：加载/创建 `config.json`、`folders.json`、`conn/*.json`
    - `SwingUtilities.invokeLater(...)`：在 EDT 中创建 `MainWindow`
    - `autoLoginControlClient()`：若记住控制端账号则后台自动登录
    - 启动 `CheckThread`：每 100ms 调用 `ControlClient.checkStatus()`（触发周期性授权刷新）
    - 初始化托盘 `SystemTrayManager`

### 0.2 配置与持久化（连接/文件夹/应用配置）

- **配置目录**
  - `ConfigManager#getConfigDirectory()`
    - Windows：`%APPDATA%/finalshell/`
    - macOS：`~/Library/Application Support/finalshell/`
    - Linux：`~/.finalshell/`
- **文件结构（当前实现）**
  - `config.json`：`AppConfig`（窗口/终端/控制端账号等）
  - `folders.json`：`FolderConfig` 列表（包含 `expanded` 展开状态）
  - `conn/*.json`：每条连接一个文件，反序列化为 `ConnectConfig`
- **连接密码加密（当前实现现状）**
  - `ConfigManager.saveConnection(...)`：会对 `ConnectConfig.password` 做 `EncryptUtil.encryptDES(...)` 后再落盘
  - `SSHSession.configureSession()`：若 `EncryptUtil.isEncrypted(password)` 为真则 `EncryptUtil.decryptDES(...)` 再 `session.setPassword(...)`
  - 这里存在“是否已加密”的判断逻辑与“编辑/保存回写”之间的协同风险（详见后文 1.5）。

### 0.3 连接打开主链路（注意：当前项目存在两套 UI 树/打开通路）

- **通路 A：主窗口左侧树 `ConnectTreePanel`（较简化）**
  - `MainWindow` 构造 -> `new ConnectTreePanel(this)`
  - 双击节点：`ConnectTreePanel.handleDoubleClick()`
  - 打开连接：`ConnectTreePanel.openConnection(ConnectConfig)`
    - 创建 `new SessionTabPanel(config)`
    - `sessionPanel.connect()` -> `TerminalPanel.connect()`
    - `TerminalPanel.connect()` 里 `new SSHSession(config)` -> `SSHSession.connect()` -> `SSHSession.openShell()`
- **通路 B：`FileTree + OpenPanel + MainWindow.openConnection`（更接近 3.8.3 的“连接管理/浮动面板”形态）**
  - `FloatDialog` 内嵌 `OpenPanel`：`openPanel.setListener(config -> mainWindow.openConnection(config))`
  - `AllPanel` 双击：`openPanel.openConnection(config)` -> listener 回到 `MainWindow.openConnection(config)`
  - `ui/filetree/FileTree` 双击：`FileTree.openConnection(VFile)` -> `OpenPanel.openConnection(config)`
  - `MainWindow.openConnection(config)`：包含 RDP 特判（`config.getType() == ConnectConfig.TYPE_RDP`）

### 0.4 授权/控制端（账号登录、Pro 状态刷新）

- **UI入口**
  - `MainWindow` 的“工具”菜单：`账号登录...` -> `showLoginDialog()` -> `LoginDialog`
  - `Pro/升级...` -> `showProIntroDialog()` -> `ui.dialog.ProIntroDialog`
- **状态刷新链路**
  - 登录：`LoginDialog.doLogin()` -> `ControlClient.login(username, password, cb)` -> `ControlClient.doLogin()`
  - 定时检查：`CheckThread.run()` -> `ControlClient.checkStatus()` -> 周期性 `checkLicense()`
  - UI展示：`MainWindow.initProStatusListener()` 注入 `SetProListener`，更新状态栏 `proLabel`

### 0.5 更新模块（当前存在“检查器/下载器”两套实现并存）

- **检查更新**
  - `MainWindow.checkForUpdates()` -> `UpdateChecker.checkUpdateAsync(cb)`
  - `UpdateChecker.checkUpdate()` 需要 `-Dupdate.check.url=...`，返回 `UpdateInfo`
- **展示与下载**
  - `UpdateChecker.showUpdateDialog(...)`：优先弹 `UpdaterDialog`（若 `parent` 是 `Frame`）
  - `UpdaterDialog.startUpdate()` -> `UpdateTools.downloadFile(...)` 下载到临时文件，未做安装/替换/重启

### 0.6 内置浏览器（SwingFXWebView）

- `SwingFXWebView` 当前是基于 `JEditorPane + HttpURLConnection` 的可用降级实现
- `executeScript(String)` 直接 `return null`，`WebViewListener.onTitleChanged` 无触发路径
- `WebViewWithAlert` 仅提供了 alert/confirm/prompt 的 Swing fallback 包装，但当前并未与“脚本执行/页面事件”形成闭环。

---

## 1. 高优先级（影响主流程/核心体验）

### 1.1 授权/账号体系（Pro/试用/过期/UI联动）仍未完整对齐

- **现状**
  - `ControlClient` 已能通过加密 HTTP 请求登录/校验，并支持：
    - `expire_time` 多格式解析（秒/毫秒/日期字符串）与过期判断
    - `CheckThread` 定时触发 `checkLicense` 刷新授权状态
    - `SetProListener` 回调 + `MainWindow` 状态栏展示 `Free/Pro/Pro(无效)`
    - 若已勾选记住密码且存在保存账号，启动后会后台自动登录以恢复授权状态刷新
- **不齐全点**
  - **缺少 3.8.3 完整的 Pro/试用/授权 UI 工作流**（例如统一入口、提示链路、状态异常时的交互）
  - 工程内存在 **两个 ProIntroDialog**：
    - `com.finalshell.ui.dialog.ProIntroDialog`：有真实 UI
    - `com.finalshell.control.ProIntroDialog`：已改为兼容包装器（继承并复用 `ui.dialog.ProIntroDialog`），避免出现同名不同行为
  - `com.finalshell.control.LoginDialog` 的 `rememberCheckBox` 已可用（账号回填；勾选后加密保存密码），但仍需继续对齐 3.8.3 的完整授权 UI 工作流
  - **关键类/调用链（用于后续对齐与定位落点）**
    - 自动登录与定时刷新：
      - `App.autoLoginControlClient()` -> `ControlClient.login(...)`
      - `CheckThread.run()` -> `ControlClient.checkStatus()` ->（到点）`checkLicense(null)`
    - UI 状态展示：
      - `MainWindow.initProStatusListener()` -> `ControlClient.setSetProListener(...)` -> `SetProListener.setProStatus(isPro,isValid)`
    - 授权判定逻辑（当前实现）：
      - `ControlClient` 内部 `valid = isPro && (isPermanent || !isExpired())`
      - `expire_time` 支持数字秒/毫秒与日期字符串，`normalizeExpireTime()` 做秒/毫秒归一

### 1.2 内置浏览器 SwingFXWebView 未对齐 3.8.3（当前为可用降级版）

- **现状**
  - `com.finalshell.ui.browser.SwingFXWebView` 已从占位替换为基于 `JEditorPane` 的可用浏览器（可加载 URL/HTML，支持前进后退/停止）
- **不齐全点**
  - `executeScript(String)` 直接 `return null`（不支持脚本执行）
  - 未对齐 3.8.3 的 JavaFX WebView（`JFXPanel/WebEngine`）能力：
    - JS 执行/对话框（alert/confirm/prompt）
    - 更可靠的页面加载/渲染/历史管理
  - `WebViewListener.onTitleChanged` 在当前实现中没有实际触发路径（能力缺口）
  - **关键类/调用链**
    - `SwingFXWebView.loadUrl(url)` -> `loadUrlInternal(url, pushHistory)`
      - `SwingWorker#doInBackground`：`HttpURLConnection GET` 拉取 HTML 字符串
      - `SwingWorker#done`：`editorPane.setText(content)` + 维护 `history/historyIndex` + 回调 `listener.onLoadFinished(url)`
    - 当前实现没有基于 DOM 的事件模型，因此：
      - 无法实现 `executeScript` / JS 对话框的“真实互操作”
      - 标题变化也无法可靠获取（`JEditorPane` 不提供 WebEngine 等能力）

### 1.3 测速（SpeedTestDialog/SpeedTestPanel）“可用但未对齐 3.8.3 结构”

- **现状**
  - `SpeedTestDialog` / `SpeedTestPanel` 已替换为真实 HTTP Ping/下载/上传（简化版）
- **不齐全点**
  - 未对齐 3.8.3 的测速架构（3.8.3 通过 `ConnectConfig + SpeedTestTask/TransEventListener` 组织任务、绘制 UI Canvas 等）
  - `SpeedTestDialog` 仍保留“模拟下载/模拟上传”字样注释（为适配工作区规则而保留），并非 3.8.3 原生实现路径
  - **关键类/调用链（当前实现）**
    - `ui.dialog.SpeedTestDialog`：
      - `testPing()`：对 URL `HEAD` 请求估算 RTT
      - `testDownload()`：`InputStream.read` 统计 10s 内吞吐，周期性更新 `downloadProgress/downloadLabel`
      - `testUpload()`：`POST` + 随机数据流式写入，统计 10s 内吞吐，周期性更新 `uploadProgress/uploadLabel`
    - `network.SpeedTestPanel`：面板版测速（被 `FloatNavPanel.showSpeedTest()` 调用）
    - 现阶段测速与“会话连接/传输框架”是解耦的（不依赖 `SSHSession/SFTP/TransTaskManager`），因此与 3.8.3 的“统一任务/事件回调/绘制”仍有明显差距。

### 1.4 软件更新链路：检查已可用，但“下载/安装/解析”仍不完整

- **现状**
  - `UpdateChecker`：能发起检查更新请求；默认占位 URL 已移除，未配置会提示 `-Dupdate.check.url=...`
- **不齐全点**
  - `UpdateTools.parseUpdateConfig(String)` 已补齐 JSON 解析，但仍需继续对齐 3.8.3 的配置字段与平台差异
  - `UpdaterDialog.startUpdate()` 已接入 `UpdateTools.downloadFile` 做真实下载，但仍未补齐安装/重启流程
  - 更新模块整体与 3.8.3 的“UpdateTools/UpdateConfig/UpdaterDialog”真实链路仍有差距（安装/重启/平台差异处理等）
  - **结构性差异（当前实现的关键不一致点）**
    - “检查更新”走 `UpdateChecker.checkUpdate()`（手写 JSON 字段映射 `version_code/version_name/download_url/...`）
    - “配置解析/多文件下载”能力在 `UpdateTools.parseUpdateConfig(...)`，但它是 `private` 且当前 `UpdateChecker` 并未复用这套解析
    - 结果是：`UpdateChecker` 与 `UpdateTools` 在字段口径/模型层面存在并行实现，后续对齐 3.8.3 时建议先确定**唯一权威的 UpdateConfig/字段口径**，避免“检查器解析口径”和“下载器解析口径”长期分叉

### 1.5 连接密码加密链路存在不一致/二次加密风险（可能导致连接失败/编辑回显异常）

- **现状（从代码可直接推导）**
  - `ConfigManager.saveConnection(...)` 会对密码做 `EncryptUtil.encryptDES(...)` 再落盘
  - `ConfigManager.loadConnections()` 读取 `conn/*.json` 后直接 `JSON.parseObject` 得到 `ConnectConfig`，**并未在加载阶段解密 password**
  - `ConnectionDialog.loadConfig()` 直接 `passwordField.setText(config.getPassword())`：若 `config.getPassword()` 是落盘后的 Base64 密文，则 UI 会回显密文
  - 用户不改密码直接保存时：`ConnectionDialog.onOK()` 取回 `passwordField` 文本再 `config.setPassword(...)`，此时 password 仍是密文
  - 再次 `saveConnection` 时会再次 `EncryptUtil.encryptDES(密文)`，导致**二次加密**
- **影响**
  - 二次加密后，`SSHSession.configureSession()` 只做一次 `decryptDES`：解密结果仍是“第一次加密的 Base64 密文”，最终 `session.setPassword(...)` 拿到的不是明文密码，SSH 认证会失败
  - 即使不发生二次加密，`EncryptUtil.isEncrypted(...)` 仅通过“能否 Base64 decode”判断是否加密，也存在误判风险（某些明文本身可能恰好是 Base64 可解码字符串）
- **建议的对齐方向（先定口径再实现）**
  - 明确 `ConnectConfig.password` 在内存态是否约定为“明文”
  - 若内存态必须为明文：则应在 `loadConnections()` 解密、在 `saveConnection()` 仅对明文加密一次，并让 UI 永远显示明文/空
  - 若内存态允许密文：则需要一个明确的 `encryptedPassword` 字段或标记，避免“UI/业务层把密文当明文再加密”的循环

- **当前修复状态（代码已落地，待验证）**
  - `EncryptUtil.encryptDES(...)`：已增加对 `enc:` 前缀的短路，避免重复加密；并对旧配置（无前缀 DES 密文）做兼容识别
  - `SSHSession`：已改用 `EncryptUtil.isDESEncrypted(...)` 识别并解密密码
  - `ConnectionDialog`：编辑连接时不回显密文；保存时密码框为空会保留原密码，避免“打开编辑直接保存”触发二次加密

---

## 2. 中优先级（功能细节/一致性/可用性）

### 2.1 连接树/编辑器/右键菜单细节仍未与 3.8.3 完整一致

- **现状**
  - 已完成：连接树重建、拖拽落盘、展开状态记忆、基本新建/删除/重命名落盘等
- **不齐全点（来自 P16）**
  - `FileTree` 数据源与 3.8.3 的细节仍有差距：
    - 节点编辑器细节
    - 右键菜单完整性
    - 连接编辑体验的一致性
  - **结构性问题：当前项目存在两套连接树实现，能力与行为不完全一致**
    - `ui.ConnectTreePanel`：结构简单，主要用于 `MainWindow` 左侧；默认 `expandAll()`，未使用 `FolderConfig.expanded` 持久化；打开连接走 `new SessionTabPanel(config)`（不包含 `MainWindow.openConnection` 的 RDP 分支）
    - `ui/filetree.FileTree + ui.OpenPanel + ui.AllPanel + ui.FloatDialog`：更像 3.8.3 的“连接管理/浮动打开”体系；支持：
      - `FolderConfig.expanded` 展开态持久化
      - `valueForPathChanged(...)` 里对连接/文件夹重命名落盘
      - `FileTreePopupMenu` 更丰富的右键菜单
    - 这两套树并存会带来：
      - 功能补齐时需要重复实现
      - “同一份配置，不同入口表现不一致”（例如 RDP 打开/菜单项/展开态等）

### 2.2 授权 UI/入口仍需梳理统一

- 目前 Pro 状态已能显示，但“入口/提示/跳转/购买引导”等仍未形成统一闭环
- `com.finalshell.control.ProIntroDialog` 空壳类应被删除/替换/接入（需要明确策略）

---

## 3. 低优先级（不影响主流程但会影响品质/一致性）

### 3.1 组件占位类（按设计可能允许存在）

- 例如 `BlankPanel`（空白占位面板）属于 UI 结构常用占位，并不一定是缺陷，但与“完全复刻”目标相比属于可审计项

---

## 4. 建议下一步优先顺序（仅建议）

1. **授权/账号体系彻底对齐**：统一 ProIntroDialog 入口/状态链路/试用与过期处理/登录信息保存策略
2. **SwingFXWebView 对齐 3.8.3 JavaFX WebView**：补齐 `executeScript` 与 JS 对话框支持
3. **更新链路补齐**：先补 `UpdateTools.parseUpdateConfig`（JSON解析）与真实下载，再补安装/重启/平台差异
4. **SpeedTest 与 3.8.3 结构对齐**：ConnectConfig + Task/Listener + Canvas 的完整链路
5. **连接树/编辑器/右键菜单细节补齐**：对照 3.8.3 逐项补全
